<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>tankuj100 - Administrace</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f9; }
    h1 { margin-bottom: 15px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px 10px; }
    th { background: #eee; }
    tr:nth-child(even) { background: #fafafa; }
    input[type="text"] { width: 100%; border: none; background: transparent; }
    button { margin: 2px; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; }
    button.add { background: #4caf50; color: white; }
    button.delete { background: #e74c3c; color: white; }
    button.save { background: #3498db; color: white; }
    .controls { margin-bottom: 10px; }
  </style>
</head>
<body>

<h1>tankuj100 Admin</h1>

<div class="controls">
  <button class="add" onclick="addRow()">â• PÅ™idat Å™Ã¡dek</button>
  <button class="delete" onclick="deleteSelected()">ğŸ—‘ï¸ Smazat vybranÃ©</button>
  <button class="save" onclick="saveToServer()">ğŸ’¾ UloÅ¾it zmÄ›ny</button>
</div>

<table id="dataTable"></table>

<script>
  let data = [];
  const table = document.getElementById("dataTable");

  async function loadData() {
    const res = await fetch("/api/stations");
    data = await res.json();
    renderTable();
  }

  function renderTable() {
    table.innerHTML = "";
    if (data.length === 0) return;

    const headerRow = document.createElement("tr");
    headerRow.innerHTML = "<th></th>" + Object.keys(data[0]).map(k => `<th>${k}</th>`).join("");
    table.appendChild(headerRow);

    data.forEach((row, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td><input type="checkbox" data-index="${idx}"></td>` +
        Object.entries(row).map(([k, v]) =>
          `<td><input type="text" value="${v ?? ''}" oninput="updateCell(${idx}, '${k}', this.value)"></td>`
        ).join("");
      table.appendChild(tr);
    });
  }

  function updateCell(index, key, value) {
    data[index][key] = value;
  }

  function addRow() {
    if (data.length === 0) return;
    const newRow = {};
    Object.keys(data[0]).forEach(k => newRow[k] = "");
    data.push(newRow);
    renderTable();
  }

  async function deleteSelected() {
  const checkboxes = table.querySelectorAll("input[type=checkbox]:checked");
  const indexesToDelete = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
  
  if (indexesToDelete.length === 0) {
    alert("NenÃ­ vybrÃ¡n Å¾Ã¡dnÃ½ Å™Ã¡dek ke smazÃ¡nÃ­.");
    return;
  }

  // ZÃ­skÃ¡nÃ­ ID pro smazÃ¡nÃ­
  const idsToDelete = indexesToDelete.map(index => data[index].id);

  // PotvrzenÃ­ od uÅ¾ivatele
  if (!confirm(`Opravdu chcete smazat ${idsToDelete.length} vybranÃ½/ch Å™Ã¡dek/Å™Ã¡dky?`)) {
    return;
  }

  let successCount = 0;
  let errorOccurred = false;

  for (const id of idsToDelete) {
    try {
      const res = await fetch(`/api/stations/${id}`, {
        method: 'DELETE'
      });
      if (res.ok) {
        successCount++;
      } else {
        errorOccurred = true;
        console.error(`Failed to delete station with ID ${id}`);
      }
    } catch (error) {
      errorOccurred = true;
      console.error(`Error during delete request for ID ${id}:`, error);
    }
  }

  // Po dokonÄenÃ­ vÅ¡ech poÅ¾adavkÅ¯, znova naÄteme data
  if (successCount > 0) {
    alert(`âœ… ÃšspÄ›Å¡nÄ› smazÃ¡no ${successCount} Å™Ã¡dkÅ¯.`);
    loadData(); // NaÄtenÃ­ dat po smazÃ¡nÃ­, aby se tabulka synchronizovala s DB
  } else if (!errorOccurred) {
     alert("âŒ Å½Ã¡dnÃ© Å™Ã¡dky nebyly smazÃ¡ny.");
  }
}

  async function saveToServer() {
    for (const row of data) {
      await fetch("/api/stations", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(row)
      });
    }
    alert("âœ… ZmÄ›ny uloÅ¾eny do databÃ¡ze");
  }

  loadData();
</script>

</body>
</html>